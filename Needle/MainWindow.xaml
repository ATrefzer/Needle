<Window x:Class="Needle.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:models="clr-namespace:Needle.Models"
        Icon="/needle.png"
        Title="Needle - File Search" Height="500" Width="800" MinWidth="1000" MinHeight="600" Background="#f3f3f3"
        FontFamily="Segoe UI" FontSize="13">
    <Window.Resources>
        <BooleanToVisibilityConverter x:Key="BoolToVis" />

        <Style TargetType="ListViewItem">
            <Setter Property="HorizontalContentAlignment" Value="Stretch" />
            <Setter Property="Padding" Value="0" />
            <Setter Property="Margin" Value="0,0,0,4" />
            <Setter Property="Focusable" Value="False" />
            <Setter Property="IsEnabled" Value="True" />
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="ListViewItem">
                        <ContentPresenter HorizontalAlignment="Stretch" />
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <DataTemplate x:Key="SearchResultTemplate" DataType="models:SearchResult">
            <StackPanel Margin="0,0,0,4">
                <!-- Header Section -->
                <Border Background="#ffffff" Padding="6" MouseLeftButtonDown="Header_MouseLeftButtonDown"
                        BorderBrush="#d0d0d0" BorderThickness="1" CornerRadius="4,4,0,0" HorizontalAlignment="Stretch">
                    <Grid HorizontalAlignment="Stretch">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto" />
                            <ColumnDefinition Width="*" />
                        </Grid.ColumnDefinitions>
                        <Border Grid.Column="0" Background="#0078d4" CornerRadius="4" Padding="6,2" Margin="0,0,8,0"
                                VerticalAlignment="Center">
                            <TextBlock Text="{Binding MatchCount}" Foreground="White" FontWeight="Bold" />
                        </Border>
                        <DockPanel Grid.Column="1" LastChildFill="True" VerticalAlignment="Center" Margin="0"
                                   HorizontalAlignment="Stretch">
                            <TextBlock Text="{Binding FileName}" FontWeight="Bold" Foreground="#222"
                                       TextWrapping="NoWrap" TextTrimming="CharacterEllipsis" DockPanel.Dock="Left" />
                            <TextBlock Text="  -  " Foreground="#666" DockPanel.Dock="Left" />
                            <TextBlock Text="{Binding FilePath}" FontSize="11" Foreground="#666" TextWrapping="NoWrap"
                                       TextTrimming="CharacterEllipsis" />
                        </DockPanel>
                    </Grid>
                </Border>

                <!-- Content Section -->
                <Border BorderBrush="#d0d0d0" BorderThickness="1,0,1,1" Padding="6" Background="#fafafa"
                        CornerRadius="0,0,4,4" x:Name="ContentBorder">
                    <ItemsControl ItemsSource="{Binding Matches}">
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <DockPanel Margin="0,0,0,4">
                                    <Border Background="#e5e5e5" Padding="4" CornerRadius="3" DockPanel.Dock="Left"
                                            Margin="0,0,8,0" MinWidth="60"
                                            Tag="{Binding DataContext, RelativeSource={RelativeSource AncestorType={x:Type ItemsControl}}}">
                                        <Border.ContextMenu>
                                            <ContextMenu>
                                                <MenuItem Header="Open in Notepad++"
                                                          Click="OpenInNotepadPlusPlus_Click" />
                                            </ContextMenu>
                                        </Border.ContextMenu>
                                        <TextBlock Text="{Binding LineNumber}" Foreground="#333" FontFamily="Consolas"
                                                   TextAlignment="Right" />
                                    </Border>
                                    <TextBlock Text="{Binding Text}" Foreground="#222" TextWrapping="Wrap"
                                               FontFamily="Consolas" />
                                </DockPanel>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </Border>
            </StackPanel>
        </DataTemplate>
    </Window.Resources>
    <Grid>
        <DockPanel>
            <StatusBar DockPanel.Dock="Bottom" Background="#ffffff" Foreground="#333" BorderBrush="#d0d0d0"
                       BorderThickness="1,1,1,0">
                <StatusBarItem>
                    <TextBlock Text="{Binding StatusMessage}" />
                </StatusBarItem>
            </StatusBar>
            <Border DockPanel.Dock="Top" Background="#ffffff" Padding="16" BorderBrush="#d0d0d0" BorderThickness="1"
                    Margin="8" CornerRadius="6">
                <StackPanel>
                    <Grid Margin="0,0,0,12">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto" />
                            <ColumnDefinition Width="*" MinWidth="200" />
                            <ColumnDefinition Width="Auto" />
                            <ColumnDefinition Width="Auto" />
                            <ColumnDefinition Width="*" MinWidth="200" />
                        </Grid.ColumnDefinitions>

                        <TextBlock Grid.Column="0" Text="Start directory:" Foreground="#444" VerticalAlignment="Center"
                                   Margin="0,0,8,0" FontWeight="SemiBold" />
                        <TextBox Grid.Column="1" Height="26" Padding="6,2" Margin="0,0,8,0" VerticalAlignment="Center"
                                 Text="{Binding StartDirectory, UpdateSourceTrigger=PropertyChanged}" />
                        <Button Grid.Column="2" Content="..." Width="26" Height="26" Margin="0,0,16,0"
                                VerticalAlignment="Center" Click="BrowseFolder_Click" ToolTip="Select folder" />

                        <TextBlock Grid.Column="3" Text="File mask:" Foreground="#444" VerticalAlignment="Center"
                                   Margin="0,0,8,0" FontWeight="SemiBold" />
                        <TextBox Grid.Column="4" Height="26" Padding="6,2" VerticalAlignment="Center"
                                 Text="{Binding FileMasks, UpdateSourceTrigger=PropertyChanged}" />
                    </Grid>
                    <Grid Margin="0,0,0,12">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto" />
                            <ColumnDefinition Width="*" />
                        </Grid.ColumnDefinitions>

                        <TextBlock Grid.Column="0" Text="Text:" Foreground="#444" VerticalAlignment="Center"
                                   Margin="0,0,8,0" FontWeight="SemiBold" />
                        <TextBox Grid.Column="1" Height="26" Padding="6,2" VerticalAlignment="Center"
                                 VerticalContentAlignment="Center"
                                 Text="{Binding Pattern, UpdateSourceTrigger=PropertyChanged}" />
                    </Grid>
                    <Grid Margin="0,0,0,8" HorizontalAlignment="Stretch">
                        <StackPanel Orientation="Horizontal" HorizontalAlignment="Left">
                            <CheckBox Content="Regex" IsChecked="{Binding IsRegex}" Margin="0,0,16,0"
                                      VerticalAlignment="Center" />
                            <CheckBox Content="Case sensitive" IsChecked="{Binding IsCaseSensitive}" Margin="0,0,16,0"
                                      VerticalAlignment="Center" />
                            <CheckBox Content="Include subdirectories" IsChecked="{Binding IncludeSubdirectories}" Margin="0,0,16,0"
                                      VerticalAlignment="Center" />
                        </StackPanel>
                        <Button HorizontalAlignment="Right" Content="Start search"
                                Command="{Binding StartSearchCommand}" Height="32" MinWidth="140" Margin="24,0,0,0"
                                VerticalAlignment="Center" />
                    </Grid>
                </StackPanel>
            </Border>
            <Border Margin="8" Background="#ffffff" BorderBrush="#d0d0d0" BorderThickness="1" CornerRadius="6"
                    Padding="8">
                <ListView ItemsSource="{Binding Results}" ItemTemplate="{StaticResource SearchResultTemplate}"
                          BorderThickness="0" Background="Transparent"
                          VirtualizingPanel.IsVirtualizing="True" VirtualizingPanel.VirtualizationMode="Recycling"
                          ScrollViewer.CanContentScroll="True"
                          IsTabStop="False" Focusable="False" />
            </Border>
        </DockPanel>
        <Grid Visibility="{Binding IsSearching, Converter={StaticResource BoolToVis}}" Background="#80000000"
              IsHitTestVisible="{Binding IsSearching}">
            <Border Background="#ffffff" Padding="24" CornerRadius="8" Width="420" HorizontalAlignment="Center"
                    VerticalAlignment="Center" BorderBrush="#d0d0d0" BorderThickness="1">
                <StackPanel>
                    <TextBlock Text="Searching ..." FontSize="16" FontWeight="Bold" Foreground="#222" />
                    <TextBlock Text="{Binding Pattern}" Margin="0,6,0,0" Foreground="#555"
                               TextTrimming="CharacterEllipsis" />
                    <ProgressBar IsIndeterminate="True" Height="10" Margin="0,20,0,0" />
                    <Button Content="Cancel" Command="{Binding CancelSearchCommand}" HorizontalAlignment="Right"
                            Margin="0,18,0,0" MinWidth="120" />
                </StackPanel>
            </Border>
        </Grid>
    </Grid>
</Window>